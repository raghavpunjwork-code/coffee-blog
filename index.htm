<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Espresso Doctor ‚Äî Diagnose My Shot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@300;400;500&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #F5EDD6;
    --espresso: #1A0A00;
    --crema: #C8864A;
    --caramel: #8B5E2E;
    --dark-roast: #2D1500;
    --light-crema: #E8C88A;
    --steam: rgba(245, 237, 214, 0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--espresso);
    color: var(--cream);
    font-family: 'Lora', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Grain texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.6;
  }

  /* Warm radial glow */
  body::after {
    content: '';
    position: fixed;
    top: -20%;
    left: 50%;
    transform: translateX(-50%);
    width: 800px;
    height: 600px;
    background: radial-gradient(ellipse, rgba(200, 134, 74, 0.12) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 760px;
    margin: 0 auto;
    padding: 60px 24px 100px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  header {
    text-align: center;
    margin-bottom: 64px;
    animation: fadeUp 0.8s ease both;
  }

  .eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--crema);
    opacity: 0.7;
    margin-bottom: 16px;
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(42px, 8vw, 72px);
    font-weight: 700;
    line-height: 1.05;
    color: var(--cream);
    margin-bottom: 8px;
  }

  h1 em {
    font-style: italic;
    color: var(--crema);
  }

  .subtitle {
    font-family: 'Lora', serif;
    font-style: italic;
    font-size: 16px;
    color: var(--cream);
    opacity: 0.55;
    margin-top: 16px;
  }

  .divider {
    width: 48px;
    height: 1px;
    background: var(--crema);
    opacity: 0.4;
    margin: 28px auto 0;
  }

  /* Form card */
  .card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(200, 134, 74, 0.2);
    border-radius: 2px;
    padding: 48px;
    animation: fadeUp 0.8s ease 0.15s both;
  }

  .question-block {
    margin-bottom: 40px;
  }

  .question-block:last-of-type {
    margin-bottom: 48px;
  }

  label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--crema);
    margin-bottom: 16px;
    opacity: 0.9;
  }

  .options-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .option-btn {
    background: transparent;
    border: 1px solid rgba(200, 134, 74, 0.25);
    color: var(--cream);
    font-family: 'Lora', serif;
    font-size: 14px;
    padding: 10px 18px;
    cursor: pointer;
    border-radius: 1px;
    transition: all 0.2s ease;
    opacity: 0.7;
  }

  .option-btn:hover {
    border-color: var(--crema);
    opacity: 1;
    background: rgba(200, 134, 74, 0.08);
  }

  .option-btn.selected {
    background: rgba(200, 134, 74, 0.18);
    border-color: var(--crema);
    color: var(--cream);
    opacity: 1;
  }

  .option-btn.multi.selected {
    background: rgba(200, 134, 74, 0.2);
    border-color: var(--light-crema);
  }

  textarea {
    width: 100%;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(200, 134, 74, 0.2);
    border-radius: 1px;
    color: var(--cream);
    font-family: 'Lora', serif;
    font-size: 15px;
    line-height: 1.6;
    padding: 16px 20px;
    resize: vertical;
    min-height: 100px;
    outline: none;
    transition: border-color 0.2s;
  }

  textarea::placeholder { color: rgba(245, 237, 214, 0.25); }
  textarea:focus { border-color: rgba(200, 134, 74, 0.6); }

  .brew-setup {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .input-group span {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    opacity: 0.5;
  }

  .input-group input {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(200, 134, 74, 0.2);
    border-radius: 1px;
    color: var(--cream);
    font-family: 'DM Mono', monospace;
    font-size: 15px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .input-group input:focus { border-color: rgba(200, 134, 74, 0.6); }
  .input-group input::placeholder { color: rgba(245, 237, 214, 0.2); }

  /* Submit button */
  .diagnose-btn {
    width: 100%;
    padding: 18px;
    background: var(--crema);
    color: var(--espresso);
    border: none;
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.02em;
    cursor: pointer;
    border-radius: 1px;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }

  .diagnose-btn:hover {
    background: var(--light-crema);
    transform: translateY(-1px);
    box-shadow: 0 8px 32px rgba(200, 134, 74, 0.3);
  }

  .diagnose-btn:active { transform: translateY(0); }

  .diagnose-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Loading */
  .loading-state {
    display: none;
    text-align: center;
    padding: 64px 0;
    animation: fadeUp 0.5s ease both;
  }

  .loading-state.visible { display: block; }

  .coffee-loader {
    font-size: 48px;
    animation: steam 1.5s ease-in-out infinite;
    display: block;
    margin-bottom: 20px;
  }

  @keyframes steam {
    0%, 100% { transform: translateY(0) rotate(-5deg); }
    50% { transform: translateY(-8px) rotate(5deg); }
  }

  .loading-text {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--crema);
    opacity: 0.6;
  }

  /* Result */
  .result-card {
    display: none;
    animation: fadeUp 0.6s ease both;
    margin-top: 40px;
  }

  .result-card.visible { display: block; }

  .result-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid rgba(200, 134, 74, 0.2);
  }

  .diagnosis-icon {
    font-size: 36px;
    flex-shrink: 0;
  }

  .result-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--cream);
  }

  .result-header .verdict {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--crema);
    opacity: 0.7;
    margin-top: 4px;
  }

  .result-body {
    font-size: 15px;
    line-height: 1.8;
    color: var(--cream);
    opacity: 0.85;
  }

  .result-body p { margin-bottom: 16px; }

  .result-body strong {
    color: var(--light-crema);
    font-weight: 600;
  }

  .fix-list {
    list-style: none;
    margin: 20px 0;
    padding: 0;
  }

  .fix-list li {
    padding: 12px 16px 12px 44px;
    position: relative;
    border-left: 2px solid rgba(200, 134, 74, 0.3);
    margin-bottom: 10px;
    font-size: 14px;
    line-height: 1.6;
    background: rgba(200, 134, 74, 0.05);
  }

  .fix-list li::before {
    content: attr(data-num);
    position: absolute;
    left: 12px;
    top: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--crema);
    font-weight: 500;
  }

  .reset-btn {
    margin-top: 40px;
    background: transparent;
    border: 1px solid rgba(200, 134, 74, 0.3);
    color: var(--cream);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 12px 24px;
    cursor: pointer;
    border-radius: 1px;
    transition: all 0.2s;
    opacity: 0.6;
  }

  .reset-btn:hover {
    opacity: 1;
    border-color: var(--crema);
  }

  .error-msg {
    background: rgba(200, 80, 80, 0.1);
    border: 1px solid rgba(200, 80, 80, 0.3);
    color: #f5a0a0;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 14px 18px;
    border-radius: 1px;
    margin-top: 16px;
    display: none;
  }

  .error-msg.visible { display: block; }

  /* Footer */
  footer {
    text-align: center;
    margin-top: 80px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--cream);
    opacity: 0.2;
    animation: fadeUp 0.8s ease 0.3s both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    .card { padding: 32px 24px; }
    .brew-setup { grid-template-columns: 1fr; }
    h1 { font-size: 40px; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <p class="eyebrow">‚òï AI-Powered Espresso Diagnostics</p>
    <h1>Diagnose My<br><em>Espresso</em></h1>
    <p class="subtitle">Tell us what went wrong. We'll tell you how to fix it.</p>
    <div class="divider"></div>
  </header>

  <div class="card" id="formCard">
    <!-- Q1: Taste -->
    <div class="question-block">
      <label>How did it taste?</label>
      <div class="options-grid" id="tasteOptions">
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Too bitter</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Too sour / acidic</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Watery / weak</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Harsh / astringent</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Salty</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Bland / flat</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Burnt / smoky</button>
        <button class="option-btn multi" data-group="taste" onclick="toggleMulti(this)">Too sweet / cloying</button>
      </div>
    </div>

    <!-- Q2: Appearance -->
    <div class="question-block">
      <label>What did the shot look like?</label>
      <div class="options-grid">
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Pale / blond crema</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Dark / tiger-striped crema</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">No crema at all</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Thick crema</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Thin / watery stream</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Fast gushing pour</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Slow dripping pour</button>
        <button class="option-btn multi" data-group="appearance" onclick="toggleMulti(this)">Uneven / channeling</button>
      </div>
    </div>

    <!-- Q3: Brew time -->
    <div class="question-block">
      <label>Shot time / brew setup</label>
      <div class="brew-setup">
        <div class="input-group">
          <span>Shot time (sec)</span>
          <input type="number" id="shotTime" placeholder="e.g. 25" min="0" max="120">
        </div>
        <div class="input-group">
          <span>Dose (grams)</span>
          <input type="number" id="dose" placeholder="e.g. 18" min="0" max="30">
        </div>
        <div class="input-group">
          <span>Yield (grams)</span>
          <input type="number" id="yield" placeholder="e.g. 36" min="0" max="100">
        </div>
      </div>
    </div>

    <!-- Q4: Grind -->
    <div class="question-block">
      <label>Grind setting change?</label>
      <div class="options-grid">
        <button class="option-btn" data-group="grind" onclick="selectOne(this)">Coarser than usual</button>
        <button class="option-btn" data-group="grind" onclick="selectOne(this)">Finer than usual</button>
        <button class="option-btn" data-group="grind" onclick="selectOne(this)">Same as always</button>
        <button class="option-btn" data-group="grind" onclick="selectOne(this)">Not sure</button>
      </div>
    </div>

    <!-- Q5: Extra notes -->
    <div class="question-block">
      <label>Anything else? (optional)</label>
      <textarea id="extraNotes" placeholder="New beans, changed something in your workflow, different water temp, etc..."></textarea>
    </div>

    <button class="diagnose-btn" onclick="diagnose()" id="diagnoseBtn">
      Diagnose My Shot ‚Üí
    </button>
    <div class="error-msg" id="errorMsg"></div>
  </div>

  <!-- Loading -->
  <div class="loading-state" id="loadingState">
    <span class="coffee-loader">‚òï</span>
    <p class="loading-text">Consulting the barista...</p>
  </div>

  <!-- Result -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="diagnosis-icon" id="diagnosisIcon">üîç</div>
      <div>
        <h2 id="diagnosisTitle">Diagnosis</h2>
        <p class="verdict" id="diagnosisVerdict"></p>
      </div>
    </div>
    <div class="result-body" id="resultBody"></div>
    <button class="reset-btn" onclick="reset()">‚Üê Diagnose Another Shot</button>
  </div>

</div>

<footer>
  <p>Espresso Doctor ¬∑ Powered by Claude AI ¬∑ Your coffee blog companion</p>
</footer>

<script>
  const selections = {};

  function toggleMulti(btn) {
    btn.classList.toggle('selected');
  }

  function selectOne(btn) {
    const group = btn.dataset.group;
    document.querySelectorAll(`[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  }

  function getSelected(group) {
    return [...document.querySelectorAll(`[data-group="${group}"].selected`)]
      .map(b => b.textContent.trim());
  }

  async function diagnose() {
    const taste = getSelected('taste');
    const appearance = getSelected('appearance');
    const grind = getSelected('grind');
    const shotTime = document.getElementById('shotTime').value;
    const dose = document.getElementById('dose').value;
    const yieldG = document.getElementById('yield').value;
    const notes = document.getElementById('extraNotes').value;

    if (taste.length === 0 && appearance.length === 0) {
      showError('Please select at least one taste or appearance descriptor.');
      return;
    }

    hideError();
    showLoading();

    const brewInfo = [];
    if (shotTime) brewInfo.push(`shot time: ${shotTime}s`);
    if (dose) brewInfo.push(`dose: ${dose}g`);
    if (yieldG) brewInfo.push(`yield: ${yieldG}g`);

    const prompt = `You are an expert barista and espresso diagnostician. A home barista is describing problems with their espresso shot. Give them a warm, expert diagnosis with specific, actionable fixes. Be conversational but authoritative ‚Äî like a helpful coffee shop mentor, not a textbook.

Their shot details:
- Taste issues: ${taste.length > 0 ? taste.join(', ') : 'not specified'}
- Visual appearance: ${appearance.length > 0 ? appearance.join(', ') : 'not specified'}
- Grind: ${grind.length > 0 ? grind[0] : 'not specified'}
${brewInfo.length > 0 ? '- Brew numbers: ' + brewInfo.join(', ') : ''}
${notes ? '- Additional notes: ' + notes : ''}

Respond in this JSON format:
{
  "icon": "(single emoji that represents the diagnosis)",
  "title": "(short catchy diagnosis title, e.g. 'Classic Over-Extraction' or 'Channeling Issue')",
  "verdict": "(one line summary of the root cause)",
  "explanation": "(2-3 sentences explaining why this happened, in plain english)",
  "fixes": ["fix 1", "fix 2", "fix 3", "fix 4"],
  "pro_tip": "(one extra advanced tip or insight)"
}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      const data = await response.json();
      const text = data.content?.map(c => c.text || '').join('') || '';
      
      // Parse JSON from response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('Could not parse response');
      
      const result = JSON.parse(jsonMatch[0]);
      showResult(result);
    } catch (err) {
      hideLoading();
      showError('Something went wrong diagnosing your shot. Please try again.');
      console.error(err);
    }
  }

  function showResult(result) {
    hideLoading();
    
    document.getElementById('diagnosisIcon').textContent = result.icon || '‚òï';
    document.getElementById('diagnosisTitle').textContent = result.title || 'Diagnosis Complete';
    document.getElementById('diagnosisVerdict').textContent = result.verdict || '';

    const fixItems = (result.fixes || []).map((fix, i) => 
      `<li data-num="${String(i+1).padStart(2,'0')}">${fix}</li>`
    ).join('');

    document.getElementById('resultBody').innerHTML = `
      <p>${result.explanation || ''}</p>
      ${fixItems ? `<strong style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.2em;text-transform:uppercase;opacity:0.7;">How to fix it</strong><ul class="fix-list">${fixItems}</ul>` : ''}
      ${result.pro_tip ? `<p style="margin-top:24px;padding:16px 20px;border-left:2px solid rgba(200,134,74,0.5);background:rgba(200,134,74,0.06);font-style:italic;opacity:0.8;"><strong style="font-style:normal;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;">Pro tip </strong><br><br>${result.pro_tip}</p>` : ''}
    `;

    document.getElementById('formCard').style.display = 'none';
    document.getElementById('resultCard').classList.add('visible');
  }

  function showLoading() {
    document.getElementById('formCard').style.display = 'none';
    document.getElementById('loadingState').classList.add('visible');
    document.getElementById('diagnoseBtn').disabled = true;
  }

  function hideLoading() {
    document.getElementById('loadingState').classList.remove('visible');
    document.getElementById('diagnoseBtn').disabled = false;
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.add('visible');
    document.getElementById('formCard').style.display = 'block';
  }

  function hideError() {
    document.getElementById('errorMsg').classList.remove('visible');
  }

  function reset() {
    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('shotTime').value = '';
    document.getElementById('dose').value = '';
    document.getElementById('yield').value = '';
    document.getElementById('extraNotes').value = '';
    document.getElementById('resultCard').classList.remove('visible');
    document.getElementById('formCard').style.display = 'block';
    hideError();
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
</script>
</body>
</html>
